<script lang="ts" setup>
import { useFileDialog } from "@vueuse/core";
import { ref } from "vue";
import {
  VButton,
  VLoading,
  Toast,
  VPageHeader,
  IconCheckboxFill,
  IconMotionLine,
  VCard,
  VSpace,
  VDropdown,
  VDropdownItem, VEmpty, VPagination
} from "@halo-dev/components";
import LazyImage from "@/components/LazyImage.vue";
import StickerEditingModal from "@/components/StickerEditingModal.vue";
import StickerGroupList from "@/components/StickerGroupList.vue";
import type {Page, Sticker} from "@/types";
import {useQuery} from "@tanstack/vue-query";
import {axiosInstance} from "@halo-dev/api-client";

const { open, reset, onChange } = useFileDialog({
  accept: ".jpg, .jpeg, .png, .gif",
  multiple: false,
});

const editingModal = ref(false);
const selectedSticker = ref(null);
const selectedStickers = ref<Set<Sticker>>(new Set<Sticker>());
const selectedGroup = ref<string>();
const checkedAll = ref(false);
const groupListRef = ref();

const page = ref(1);
const size = ref(20);
const total = ref(0);
const keyword = ref("");

const selectedFile = ref<File | null>(null);
const uploadLoading = ref(false);

onChange((files) => {
  if (files && files.length > 0) {
    selectedFile.value = files[0];
  }
});

const handleUploadFile = async () => {
  if (!selectedFile.value) {
    Toast.error("No file selected");
    return;
  }

  const formData = new FormData();
  formData.append("file", selectedFile.value);

  uploadLoading.value = true;

  const uploadUrl = new URL(
    "/apis/console.api.sticker.halo.run/v1alpha1/sticker/-/upload",
    window.location.origin,
  );
  uploadUrl.searchParams.append("sticker-group", "-");

  try {
    console.log("uploadUrl", uploadUrl);
    const response = await fetch(uploadUrl, {method: "POST", body: formData});

    if (!response.ok) {
      throw new Error("Upload failed");
    }

    Toast.success("File uploaded successfully");
  } catch (error) {
    Toast.error("File upload failed");
  } finally {
    uploadLoading.value = false;
    reset();
  }
}

const {
  data: stickers,
  isLoading,
  refetch,
} = useQuery<Array<Sticker>>({
  queryKey: [page, size, keyword, selectedGroup],
  queryFn: async () => {
    if (!selectedGroup.value) {
      return [];
    }
    const { data } = await axiosInstance.get<Page<Sticker>>("/apis/storage.halo.run/v1alpha1/stickers", {
      params: {
        page: page.value,
        size: size.value,
        keyword: keyword.value,
        group: selectedGroup.value,
      },
    });
    total.value = data.total;
    return data.items
      .map((group) => {
        if (group.spec) {
          group.spec.priority = group.spec.priority || 0;
        }
        return group;
      })
      .sort((a, b) => {
        return (a.spec?.priority || 0) - (b.spec?.priority || 0);
      });
  },
  refetchInterval(data) {
    // const deletingGroups = data?.filter((group) => !!group.metadata.deletionTimestamp);
    //
    // return deletingGroups?.length ? 1000 : false;
  },
  refetchOnWindowFocus: false,
});

const groupSelectHandle = (group?: string) => {
  selectedGroup.value = group;
};

const handleCheckAllChange = (e: Event) => {
  const { checked } = e.target as HTMLInputElement;
  handleCheckAll(checked);
};

const handleCheckAll = (checkAll: boolean) => {
  if (checkAll) {
    stickers.value?.forEach((photo) => {
      selectedStickers.value.add(photo);
    });
  } else {
    selectedStickers.value.clear();
  }
};

  const pageRefetch = async () => {
    // refetch data
  };
</script>

<template>
  <StickerEditingModal
    v-model:visible="editingModal"
    :photo="selectedSticker"
    :group="selectedGroup"
    >
<!--    @close="refetch"-->
<!--    @saved="pageRefetch"-->
  
  </StickerEditingModal>
  
  <VPageHeader title="表情包">
    <template #icon>
      <IconMotionLine class="mr-2 self-center" />
    </template>
  </VPageHeader>

  <div class="p-4">
    <div class="flex flex-col gap-2 lg:flex-row">
      <div class="w-full flex-none lg:w-96">
        <StickerGroupList ref="groupListRef" @select="groupSelectHandle" />
      </div>
      <div class="flex-1 shrink min-w-0">
        <VCard>
          <template #header>
            <div class="block w-full bg-gray-50 px-4 py-3">
              <div class="relative flex flex-col items-start sm:flex-row sm:items-center">
                <div class="mr-4 hidden items-center sm:flex">
                  <input v-model="checkedAll" type="checkbox" @change="handleCheckAllChange" />
                </div>
                <div class="flex w-full flex-1 sm:w-auto">
                  <SearchInput v-if="!selectedStickers.size" v-model="keyword" />
                  <VSpace v-else>
                    <VButton type="danger" @click="handleDeleteInBatch"> 删除 </VButton>
                  </VSpace>
                </div>
                <div v-if="selectedGroup" v-permission="['plugin:photos:manage']" class="mt-4 flex sm:mt-0">
                  <VDropdown>
                    <VButton size="xs"> 新增 </VButton>
                    <template #popper>
                      <VDropdownItem @click="handleUploadFile()"> 新增 </VDropdownItem>
<!--                      <VDropdownItem @click="attachmentModal = true"> 从附件库选择 </VDropdownItem>-->
                    </template>
                  </VDropdown>
                </div>
              </div>
            </div>
          </template>
          <VLoading v-if="uploadLoading" />
          <Transition v-else-if="!selectedGroup" appear name="fade">
            <VEmpty message="请选择或新建分组" title="未选择分组"></VEmpty>
          </Transition>
          <Transition v-else-if="!searchResults.length" appear name="fade">
            <VEmpty message="你可以尝试刷新或者新建图片" title="当前没有图片">
              <template #actions>
                <VSpace>
                  <VButton @click="refetch"> 刷新</VButton>
                  <VButton v-permission="['plugin:photos:manage']" type="primary" @click="handleOpenEditingModal()">
                    <template #icon>
                      <IconAddCircle class="size-full" />
                    </template>
                    新增图片
                  </VButton>
                </VSpace>
              </template>
            </VEmpty>
          </Transition>
          <Transition v-else appear name="fade">
            <div class="mt-2 grid grid-cols-1 gap-x-2 gap-y-3 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5" role="list">
              <VCard
                v-for="photo in photos"
                :key="photo.metadata.name"
                :body-class="['!p-0']"
                :class="{
                  'ring-primary ring-1': isChecked(photo),
                  'ring-1 ring-red-600': photo.metadata.deletionTimestamp,
                }"
                class="hover:shadow"
                @click="handleOpenEditingModal(photo)"
              >
                <div class="group relative bg-white">
                  <div class="aspect-16/9 block size-full cursor-pointer overflow-hidden bg-gray-100">
                    <LazyImage
                      :key="photo.metadata.name"
                      :alt="photo.spec.displayName"
                      :src="photo.spec.cover || photo.spec.url"
                      classes="size-full pointer-events-none group-hover:opacity-75"
                    >
                      <template #loading>
                        <div class="flex h-full justify-center">
                          <VLoading></VLoading>
                        </div>
                      </template>
                      <template #error>
                        <div class="flex h-full items-center justify-center object-cover">
                          <span class="text-xs text-red-400"> 加载异常 </span>
                        </div>
                      </template>
                    </LazyImage>
                  </div>

                  <p
                    v-tooltip="photo.spec.displayName"
                    class="block cursor-pointer truncate px-2 py-1 text-center text-xs font-medium text-gray-700"
                  >
                    {{ photo.spec.displayName }}
                  </p>

                  <div v-if="photo.metadata.deletionTimestamp" class="absolute top-1 right-1 text-xs text-red-300">
                    删除中...
                  </div>

                  <div
                    v-if="!photo.metadata.deletionTimestamp"
                    v-permission="['plugin:photos:manage']"
                    :class="{ '!flex': selectedStickers.has(photo) }"
                    class="absolute top-0 left-0 hidden h-1/3 w-full cursor-pointer justify-end bg-gradient-to-b from-gray-300 to-transparent ease-in-out group-hover:flex"
                    @click.stop="selectedStickers.has(photo) ? selectedStickers.delete(photo) : selectedStickers.add(photo)"
                  >
                    <IconCheckboxFill
                      :class="{
                        '!text-primary': selectedStickers.has(photo),
                      }"
                      class="hover:text-primary mt-1 mr-1 h-6 w-6 cursor-pointer text-white transition-all"
                    />
                  </div>
                </div>
              </VCard>
            </div>
          </Transition>

          <template #footer>
            <VPagination v-model:page="page" v-model:size="size" :total="total" :size-options="[20, 30, 50, 100]" />
          </template>
        </VCard>
      </div>
    </div>
  </div>
  
</template>

<style lang="scss" scoped></style>
